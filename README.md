# Лабораторная работа № 4

**Группа:** Аэ-21-22

**Команда:**
- Обухов Д. А. (менеджер/аналитик)
- Осипов М. А. (разработчик)
- Романов Д. А. (тестировщик)

**Заказчик:** Емельянов Д. М.

---

## Содержание

1. [Постановка задачи](#постановка-задачи)
2. [Уточнения у заказчика](#уточнения-у-заказчика)
3. [Техническое задание](#техническое-задание)
4. [Код программы](#код-программы)
5. [Примеры использования](#примеры-использования)
6. [Тестирование](#тестирование)
7. [Источники](#источники)

---

## Постановка задачи

### Задание

Лабораторная работа № 4 выполняется всей бригадой и требует разработки одного или нескольких bash/shell скриптов.
Для этого участникам бригады необходимо распределить между собой роли менеджера, аналитика, разработчика и тестировщика.

Преподаватель (далее - заказчик) выдвигает следующие функциональные требования к разрабатываемому _Решению_ под ОС Linux:

1. В качестве предметной области и исходных данных выступает Файловая Система Преподавателя из Лабораторной работы № 3.

2. Базовое решение для успешной сдачи лабораторной работы должно предоставлять следующие возможности по заданному пользователем номеру группы:
   - вывод имени студента с максимальным количеством пятёрок/четвёрок/троек по тестам, вывод таких результатов;

3. Для получения Отличной оценки (и потенциально дополнительных баллов) также необходимо в рамках решения реализовать:
   - вывод списка группы, упорядоченного по успеваемости;
   - вывод по фамилиям студентов их досье;

Требования могут уточняться менеджером или аналитиком бригады лично с заказчиком.

В качестве отчётности, кроме демонстрации заказчику работоспособных скриптов, необходимо предоставить краткую документацию
решения (в электронном виде), отчёт о проведённом тестировании (в электронном виде), а также документировать основные моменты разработки.

---

## Уточнения у заказчика

### Согласованное техническое задание

**Полученные условия:**

1. В качестве предметной области и исходных данных выступает Файловая Система Преподавателя из Лабораторной работы № 3.

2. Базовое решение для успешной сдачи лабораторной работы должно предоставлять следующие возможности по заданному пользователем номеру группы:
   - вывод имени студента с максимальным количеством пятёрок/четвёрок/троек по тестам, вывод таких результатов;
   - вывод списка группы, упорядоченного по успеваемости;
   - вывод по фамилиям студентов их досье;

**Описание продукта для согласования с заказчиком:**

Решение представляет собой создание CLI приложения, способного поддерживать общение с пользователем с помощью специальных меню выбора.
Основываясь на пункте 1 полученных условий, будут введены ограничения на количество предметов, по которым можно будет отслеживать
успеваемость: **Поп-Культуроведение** и **Цирковое дело**.

Для наглядности и удобочитаемости информации все выводы будут формироваться в таблицу с заголовками и значениями.

### Описание функционала

#### 1. Вывод имени студента с максимальным количеством пятёрок/четвёрок/троек по тестам

Вывод будет состоять из трёх таблиц и подписей к ним. Подпись формируется над таблицей. Таблица состоит из 5 столбцов:
- **Студент** (имя студента)
- **Группа** (номер группы)
- **Кол-во 3** (общее количество оценок 3 за все тесты)
- **Кол-во 4** (общее количество оценок 4 за все тесты)
- **Кол-во 5** (общее количество оценок 5 за все тесты)

Формат вывода:
```
Максимальное количество оценок 3
Студент    Группа    Кол-во 3    Кол-во 4    Кол-во 5

Максимальное количество оценок 4
Студент    Группа    Кол-во 3    Кол-во 4    Кол-во 5

Максимальное количество оценок 5
Студент    Группа    Кол-во 3    Кол-во 4    Кол-во 5
```

#### 2. Вывод списка группы, упорядоченного по успеваемости

Под "успеваемостью" примем средний балл за совокупность тестов. В сводной таблице будет представлено четыре колонки:
- **Группа** (название группы)
- **Поп-Культуроведение** (средний балл за тест по Поп-Культуроведению)
- **Цирковое дело** (средний балл за тест по Цирковому делу)
- **Общее усреднённое** (общий средний балл за два предмета)

В данном пункте присутствуют математические операции, в том числе и деление, что подразумевает под собой необходимость
округления значений средних баллов до двух знаков после запятой, то есть формат числа будет иметь следующий вид - 0.00.

Таблица отсортирована по убыванию общего среднего балла, а в случае их совпадения - по фамилии учащегося.

Формат вывода:
```
Сводная таблица с успеваемостью для учебных групп
Группа    Поп-Культуроведение    Цирковое дело    Общее усреднённое
```

#### 3. Вывод по фамилиям студентов их досье

Вывод досье будет реализован тремя способами для более удобного формата чтения. Для пользователя будут доступны:
- Вывод по фамилии студента
- Вывод по номеру группы
- Вывод всех досье

Формат выходной таблице представлен ниже и имеет три колонки:
- **Студент** (имя студента)
- **Группа** (номер группы)
- **Досье** (само досье)

Названия столбцов таблиц и подписи к ним согласуются с заказчиком и могут меняться до момента официальной договоренности
между заказчиком и исполнителем. После правки обсуждаются с учётом трудозатрат.

---

## Техническое задание

### Общие сведения

**Название скрипта:** `lab4.sh`

**Общая справка:** `-h`, `--help` - показать справку по командам

**Формат вызова:** `./lab4.sh [ФЛАГ] [ПАРАМЕТРЫ]`

**Структура файловой системы:**

Файловая система находится в директории `labfiles-25/` и имеет следующую структуру:

```
labfiles-25/
├── students/
│   ├── groups/          # Файлы со списками студентов по группам
│   │   ├── A-06-04
│   │   ├── A-06-05
│   │   └── ...
│   └── general/
│       └── notes/       # Досье студентов
│           ├── ANames.log
│           ├── BNames.log
│           └── ...
├── Поп-Культуроведение/
│   ├── tests/
│   │   ├── TEST-1
│   │   ├── TEST-2
│   │   ├── TEST-3
│   │   └── TEST-4
│   ├── A-06-04-attendance
│   └── ...
└── Цирковое_Дело/
    ├── tests/
    │   ├── TEST-1
    │   ├── TEST-2
    │   ├── TEST-3
    │   └── TEST-4
    ├── A-06-04-attendance
    └── ...
```

### Флаги и функции

#### 1. Флаг: --best-grades

**Назначение:** Вывод студентов с максимальным количеством троек, четвёрок и пятёрок по тестам

**Формат:** `./lab4.sh --best-grades <номер_группы>`

**Входные данные:**
- Номер группы (формат: `A-XX-XX` или `Ae-XX-XX`)

**Логика:**
1. Найти всех студентов группы из файла `students/groups/<номер_группы>`

2. Для каждого студента подсчитать количество троек, четверок и пятерок из всех тестов:
   - `Поп-Культуроведение/tests/TEST-[1-4]`
   - `Цирковое_Дело/tests/TEST-[1-4]`

3. Формат данных в тестах: CSV с колонками: `Группа;Студент;Дата;Баллы;Оценка`

4. Найти студента с максимальным количеством троек, четвёрок и пятёрок (три отдельные таблицы)

**Пример:**
```bash
Входные данные: ./lab4.sh --best-grades A-06-04
Выходные данные:
==========================================
Анализ оценок для группы 'A-06-04'
==========================================

Максимальное количество оценок 3
Студент                   | Группа          | Кол-во 3     | Кол-во 4     | Кол-во 5
--------------------------------------------------------------------------------------------
PanovD                    | A-06-04         | 6            | 2            | 0

Максимальное количество оценок 4
Студент                   | Группа          | Кол-во 3     | Кол-во 4     | Кол-во 5
--------------------------------------------------------------------------------------------
ZdorovovP                 | A-06-04         | 2            | 6            | 0

Максимальное количество оценок 5
Студент                   | Группа          | Кол-во 3     | Кол-во 4     | Кол-во 5
--------------------------------------------------------------------------------------------
KozlovskyE                | A-06-04         | 0            | 2            | 6
```

**Особенности:**
- Если несколько студентов имеют одинаковый максимум - выводим первого найденного
- Суммируем оценки по всем 8 тестам (4 теста × 2 предмета)
- При некорректном вводе: "Ошибка: Неверное количество аргументов"

#### 2. Флаг: --performance

**Назначение:** Вывод списка группы, упорядоченного по успеваемости (средний балл)

**Формат:** `./lab4.sh --performance <номер_группы>`

**Входные данные:**
- Номер группы (формат: `A-XX-XX` или `Ae-XX-XX`)

**Логика:**
1. Найти всех студентов группы
2. Для каждого студента собрать все оценки из тестов обоих предметов
3. Конвертировать оценки в числовой формат (5++, 5+, 5, 5- → числовые значения)
4. Вычислить средний балл по каждому предмету и общий средний балл
5. Отсортировать по общему среднему баллу (по убыванию)

**Пример:**
```bash
Входные данные: ./lab4.sh --performance A-06-04
Выходные данные:
==========================================
Сводная таблица с успеваемостью для группы 'A-06-04'
==========================================

Студент                    | Поп-Культуроведение        | Цирковое дело       | Общее усреднённое
-----------------------------------------------------------------------------------------------
BoriskinaI                 | 4.00                       | 4.00                | 4.00
BaryshevaT                 | 3.80                       | 4.00                | 3.90
KozlovskyE                 | 3.83                       | 3.38                | 3.57
```

**Особенности:**
- Средние баллы округлены до двух знаков после запятой (формат: 0.00)
- При некорректном вводе: "Ошибка: Неверное количество аргументов"

#### 3. Флаг: --dossier-student

**Назначение:** Вывод досье студента по фамилии

**Формат:** `./lab4.sh --dossier-student <ФИО_студента>`

**Входные данные:**
- Фамилия студента (формат: заглавная буква, затем строчные/заглавные)

**Логика:**
1. Определить первую букву фамилии студента
2. Найти соответствующий файл в `students/general/notes/<буква>Names.log`
3. Извлечь досье студента между разделителями `=====`
4. Вывести досье

**Пример:**
```bash
Входные данные: ./lab4.sh --dossier-student PashkovskyA
Выходные данные:
==========================================
Досье студента: PashkovskyA
==========================================

Клонит в сон от его храпа. Сосочек. Ничего не записывает.
Делает сэлфи на каждой лекции. Подлизывается, это можно
использовать! Клонит в сон от его храпа. Спит на лекциях!
```

**Особенности:**
- При некорректном вводе: "Ошибка: Неверное количество аргументов"
- Если досье не найдено: "Ошибка: У студента 'XXX' нет досье"

#### 4. Флаг: --dossier-group

**Назначение:** Вывод досье всех студентов группы

**Формат:** `./lab4.sh --dossier-group <номер_группы>`

**Входные данные:**
- Номер группы (формат: `A-XX-XX` или `Ae-XX-XX`)

**Логика:**
1. Прочитать список студентов группы
2. Для каждого студента найти и извлечь досье
3. Вывести в табличном формате (с ограничением длины для читаемости)

**Пример:**
```bash
Входные данные: ./lab4.sh --dossier-group A-06-04
Выходные данные:
==========================================
Досье студентов группы 'A-06-04'
==========================================

Студент              | Группа     | Досье
--------------------------------------------------------------------------------------------
PashkovskyA          | A-06-04    | Клонит в сон от его храпа. Сосочек. Ничего не записывает...
SmugalovI            | A-06-04    | Подлизывается, это можно использовать! Ничего не записы...
```

**Особенности:**
- Досье обрезается до 70 символов для табличного вывода
- Если у студента нет досье: выводится "Нет досье"

#### 5. Флаг: --dossier-all

**Назначение:** Вывод всех досье студентов

**Формат:** `./lab4.sh --dossier-all`

**Входные данные:** Не требуются

**Логика:**
1. Прочитать все файлы досье из `students/general/notes/*Names.log`
2. Извлечь имена студентов и их досье
3. Для каждого студента найти группу
4. Вывести в табличном формате

**Пример:**
```bash
Входные данные: ./lab4.sh --dossier-all
Выходные данные:
==========================================
Все досье студентов
==========================================

Студент              | Группа     | Досье
--------------------------------------------------------------------------------------------
PashkovskyA          | A-06-04    | Клонит в сон от его храпа. Сосочек. Ничего не записывает...
SmugalovI            | A-06-04    | Подлизывается, это можно использовать! Ничего не записы...
```

**Особенности:**
- Выводятся все студенты из всех файлов досье
- Если группа студента не найдена: выводится "Не найдена"

### Общие требования

- Обработка ошибок ввода
- Временные файлы должны удаляться после использования
- Для флагов `--best-grades`, `--performance`, `--dossier-group` номер группы ОБЯЗАТЕЛЕН
- Для флага `--dossier-student` требуется фамилия студента
- Для флага `--dossier-all` аргументы НЕ ТРЕБУЮТСЯ
- Проверка прав доступа к файлам
- Корректная обработка несуществующих групп и студентов
- Справка по всем флагам через `--help` или `-h`
- Скрипт совместим с bash 3.2+ (работает на macOS и Linux)

---

## Код программы

Скрипт `lab4.sh` реализует все требуемые функции с полной обработкой ошибок и валидацией входных данных.

### Структура скрипта

#### 1. Функции справки

Скрипт содержит главную функцию справки:
- `print_help()` - общая справка по всем флагам

#### 2. Валидация входных данных

Для каждого флага реализована многоуровневая проверка:
- `validate_group()` - проверка формата и существования группы
- `validate_student()` - проверка существования студента в досье
- Проверка количества аргументов
- Проверка формата номера группы (regex: `^(A|Ae)-[0-9]{2}-[0-9]{2}$`)
- Проверка существования файлов и директорий
- Проверка прав доступа к файлам

#### 3. Реализация функций

##### Функция count_grades (--best-grades)

```bash
count_grades() {
    local group="$1"
    local temp_file=$(mktemp)

    # Для каждого студента подсчитываем количество троек, четвёрок, пятёрок
    while IFS= read -r student; do
        # Проходим по всем тестам обоих предметов
        for subject_dir in "$POP_DIR" "$CIRCUS_DIR"; do
            for test_file in "$subject_dir/tests/TEST-"[1-4]; do
                # Подсчёт оценок
                # ...
            done
        done

        echo "$student|$count_3|$count_4|$count_5" >> "$temp_file"
    done < "$GROUPS_DIR/$group"

    # Находим студентов с максимумами и выводим три таблицы
    # ...
}
```

**Особенности:**
- Использует временные файлы для хранения данных (совместимость с bash 3.2)
- Обрабатывает оценки с модификаторами (+, -)
- Выводит три отдельные таблицы для троек, четвёрок и пятёрок

##### Функция show_performance (--performance)

```bash
show_performance() {
    local group="$1"
    local temp_file=$(mktemp)

    # Для каждого студента вычисляем средние баллы
    while IFS= read -r student; do
        # Собираем оценки по Поп-Культуроведению
        # Собираем оценки по Цирковому делу
        # Вычисляем средние баллы

        pop_avg=$(awk "BEGIN {printf \"%.2f\", $pop_sum / $pop_count}")
        circus_avg=$(awk "BEGIN {printf \"%.2f\", $circus_sum / $circus_count}")
        overall_avg=$(awk "BEGIN {printf \"%.2f\", ($pop_sum + $circus_sum) / $total_count}")

        echo "$student|$pop_avg|$circus_avg|$overall_avg" >> "$temp_file"
    done < "$GROUPS_DIR/$group"

    # Сортируем по общему среднему баллу (по убыванию)
    sort -t'|' -k4 -rn -k1 "$temp_file" | ...
}
```

**Особенности:**
- Конвертирует оценки в числовой формат через функцию `convert_grade_to_number()`
- Использует awk для точного округления до двух знаков после запятой
- Сортирует результаты по убыванию общего среднего балла

##### Функция show_dossier_student (--dossier-student)

```bash
show_dossier_student() {
    local student="$1"
    local first_letter="${student:0:1}"
    local file="$NOTES_DIR/${first_letter}Names.log"

    # Извлекаем досье с помощью sed
    sed -n "/^$student$/,/^====/{
        /^$student$/d
        /^====/q
        p
    }" "$file"
}
```

**Особенности:**
- Использует sed для извлечения текста между разделителями
- Автоматически определяет файл по первой букве фамилии
- Выводит только одно досье (до следующего разделителя)

##### Функции show_dossier_group и show_dossier_all

Аналогичны функции `show_dossier_student`, но обрабатывают множество студентов и выводят результаты в табличном формате
с ограничением длины досье.

#### 4. Обработка ошибок

Скрипт обрабатывает следующие типы ошибок:

1. **Ошибки ввода:**
   - Отсутствие аргументов
   - Неверное количество аргументов
   - Неверный формат номера группы
   - Некорректное имя студента
   - Неизвестный флаг

2. **Ошибки файловой системы:**
   - Несуществующая группа
   - Несуществующий файл досье
   - Отсутствие прав на чтение файлов
   - Отсутствие базовой директории `labfiles-25`

3. **Специальные случаи:**
   - Пустые файлы
   - Несколько студентов с одинаковым результатом (выводится первый)
   - Студенты без досье

#### 5. Особенности реализации

- **Использование `shopt -s nullglob`** - предотвращает ошибки при отсутствии файлов в glob-паттернах
- **Временные файлы вместо ассоциативных массивов** - для совместимости с bash 3.2
- **Проверка прав доступа** - перед каждым чтением файла
- **AWK для математических операций** - точное округление до двух знаков после запятой
- **SED для извлечения досье** - эффективная работа с текстом между разделителями
- **Регулярные выражения** - для валидации формата группы

---

## Примеры использования

### Пример 1: Справка

```bash
$ ./lab4.sh --help
Использование: ./lab4.sh [ФЛАГ] [АРГУМЕНТЫ]

ФЛАГИ:
  -h, --help                     Показать эту справку

  --best-grades <группа>         Вывод студентов с максимальным количеством
                                 троек, четвёрок и пятёрок по тестам

  --performance <группа>         Вывод списка группы, упорядоченного по
                                 успеваемости (средний балл)

  --dossier-student <фамилия>    Вывод досье студента по фамилии

  --dossier-group <группа>       Вывод досье всех студентов группы

  --dossier-all                  Вывод всех досье студентов

ФОРМАТ НОМЕРА ГРУППЫ:
  A-XX-XX или Ae-XX-XX (например: A-06-04, Ae-21-22)

ПРИМЕРЫ:
  ./lab4.sh --best-grades A-06-04
  ./lab4.sh --performance Ae-21-22
  ./lab4.sh --dossier-student PashkovskyA
  ./lab4.sh --dossier-group A-06-04
  ./lab4.sh --dossier-all
```

### Пример 2: Анализ оценок

```bash
$ ./lab4.sh --best-grades A-06-04
==========================================
Анализ оценок для группы 'A-06-04'
==========================================

Максимальное количество оценок 3
Студент                   | Группа          | Кол-во 3     | Кол-во 4     | Кол-во 5
--------------------------------------------------------------------------------------------
PanovD                    | A-06-04         | 6            | 2            | 0

Максимальное количество оценок 4
Студент                   | Группа          | Кол-во 3     | Кол-во 4     | Кол-во 5
--------------------------------------------------------------------------------------------
ZdorovovP                 | A-06-04         | 2            | 6            | 0

Максимальное количество оценок 5
Студент                   | Группа          | Кол-во 3     | Кол-во 4     | Кол-во 5
--------------------------------------------------------------------------------------------
KozlovskyE                | A-06-04         | 0            | 2            | 6
```

### Пример 3: Анализ успеваемости

```bash
$ ./lab4.sh --performance A-06-04
==========================================
Сводная таблица с успеваемостью для группы 'A-06-04'
==========================================

Студент                    | Поп-Культуроведение        | Цирковое дело       | Общее усреднённое
-----------------------------------------------------------------------------------------------
BoriskinaI                 | 4.00                       | 4.00                | 4.00
BaryshevaT                 | 3.80                       | 4.00                | 3.90
KozlovskyE                 | 3.83                       | 3.38                | 3.57
SivoronovS                 | 3.83                       | 3.00                | 3.38
...
```

### Пример 4: Вывод досье студента

```bash
$ ./lab4.sh --dossier-student PashkovskyA
==========================================
Досье студента: PashkovskyA
==========================================

Клонит в сон от его храпа. Сосочек. Ничего не записывает. Делает сэлфи на каждой лекции. Подлизывается, это можно использовать! Клонит в сон от его храпа. Спит на лекциях!
```

### Пример 5: Вывод досье группы

```bash
$ ./lab4.sh --dossier-group A-06-04
==========================================
Досье студентов группы 'A-06-04'
==========================================

Студент                        | Группа          | Досье
--------------------------------------------------------------------------------------------
PashkovskyA                    | A-06-04         | Клонит в сон от его храпа. Сосочек. Ничего не записывает. Делает сэлфи на каждой лекции. Подлизывается, это можно использовать! Клонит в сон от его храпа. Спит на лекциях!
SmugalovI                      | A-06-04         | Подлизывается, это можно использовать! Ничего не записывает. Белый снаружи, черный внутри) Постоянно выходит разговаривать с тещей!
...
```

### Пример 6: Обработка ошибок

```bash
$ ./lab4.sh --best-grades A-99-99
Ошибка: Группа 'A-99-99' не существует
Доступные группы:
A-06-04
A-06-05
A-06-06
...

$ ./lab4.sh --dossier-student NonExistentStudent
Ошибка: У студента 'NonExistentStudent' нет досье

$ ./lab4.sh --unknown-flag
Ошибка: Неизвестный флаг '--unknown-flag'
Используйте --help для справки
```

---

## Тестирование

Для проверки корректности работы скрипта был разработан полный набор тест-кейсов.
Подробное описание тестирования доступно в файле [test_cases.md](test_cases.md).

### Краткая сводка тестирования

| Флаг | Количество тестов | Успешно пройдено |
|------|-------------------|------------------|
| Общие тесты | 5 | ✅ 5 |
| --best-grades | 8 | ✅ 8 |
| --performance | 8 | ✅ 8 |
| --dossier-student | 6 | ✅ 6 |
| --dossier-group | 6 | ✅ 6 |
| --dossier-all | 3 | ✅ 3 |
| **ИТОГО** | **36** | **✅ 36** |

Все тест-кейсы успешно пройдены. Скрипт корректно обрабатывает:
- ✅ Все нормальные ситуации использования
- ✅ Все аномальные ситуации и ошибки ввода
- ✅ Несуществующие группы и студентов
- ✅ Специальные случаи (одинаковые результаты, пустые значения)
- ✅ Проверку прав доступа к файлам

---

## Источники

1. Bash Reference Manual - GNU Project. URL: https://www.gnu.org/software/bash/manual/
2. Advanced Bash-Scripting Guide. URL: https://tldp.org/LDP/abs/html/
3. AWK Programming Language. URL: https://www.gnu.org/software/gawk/manual/
4. SED - Stream Editor. URL: https://www.gnu.org/software/sed/manual/
5. Материалы лабораторной работы № 3 (Файловая система преподавателя)

---

**Дата выполнения:** 2025-11-15

**Версия скрипта:** 1.0

**Совместимость:** Bash 3.2+, macOS, Linux
